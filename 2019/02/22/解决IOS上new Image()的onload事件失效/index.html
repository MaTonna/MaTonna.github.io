<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>解决IOS上new Image()的onload事件失效 | MaTonna's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">解决IOS上new Image()的onload事件失效</h1><a id="logo" href="/.">MaTonna's blog</a><p class="description">关于学习，时间会给你答案</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">解决IOS上new Image()的onload事件失效</h1><div class="post-meta">Feb 22, 2019<span> | </span><span class="category"><a href="/categories/tips/">tips</a></span></div><div class="post-content"><h3>业务场景：</h3>
<p>H5 的客服中，根据用户输入付款金额以及选择付款方式，生成一张带有付款二维码、付款金额、若干提示语的图片。</p>
<h3>封装绘制方法的基本思路：</h3>
<ol>
<li>调用接口获得二维码图片地址</li>
<li>new Image()并 onload 后在 canvas 上绘制图片生成信息</li>
<li>完成绘制后执行回调，返回 canvas</li>
<li>回调中调用 canvas.toDataURL('image/png')将 canvas 转成 base64</li>
</ol>
<h3>遇到的问题：</h3>
<p>在 IOS 中无法绘制图片，经过排查发现是因为 onload 事件失效，所以使用 fetch()获取图片，在 then()中做后续操作。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">// 调用绘制二维码</span><br><span class="line">this.drawPayQRCode(&#123;</span><br><span class="line">  qrImgUrl: &apos;二维码地址&apos;,</span><br><span class="line">  logoImgUrl: &apos;支付通道的 logo&apos;,</span><br><span class="line">  sum: &apos;金额&apos;,</span><br><span class="line">  userLoginName: &apos;用户名&apos;,</span><br><span class="line">  branchName: &apos;彩店名&apos;,</span><br><span class="line">  payproductName: &apos;支付通道名&apos;,</span><br><span class="line">  tipList: [&apos;文案 1&apos;,&apos;文案 2&apos;,&apos;文案 3&apos;],</span><br><span class="line">  callback: function(canvas) &#123;</span><br><span class="line">    const imgUrl = canvas.toDataURL(&apos;image/png&apos;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">// 定义绘制二维码的方法</span><br><span class="line">drawPayQRCode(options) &#123;</span><br><span class="line">  const canvas = document.createElement(&apos;canvas&apos;);</span><br><span class="line">  const canvasWidth = 280;</span><br><span class="line">  const canvasHeight = 270;</span><br><span class="line">  canvas.width = canvasWidth;</span><br><span class="line">  canvas.height = canvasHeight;</span><br><span class="line">  const context = canvas.getContext(&apos;2d&apos;);</span><br><span class="line"></span><br><span class="line">  // 定义背景色</span><br><span class="line">  context.fillStyle = &apos;#fff&apos;;</span><br><span class="line">  context.fillRect(0, 0, canvasWidth, canvasHeight);</span><br><span class="line"></span><br><span class="line">  //定义二维码和支付通道 logo 的位置</span><br><span class="line">  const qrL = (280 - 150) / 2;</span><br><span class="line">  const qrR = 26;</span><br><span class="line">  const qrWH = 150;</span><br><span class="line">  const logoL = (280 - 24) / 2;</span><br><span class="line">  const logoR = 89;</span><br><span class="line">  const logoWH = 24;</span><br><span class="line"></span><br><span class="line">    const qrImg = new Image();</span><br><span class="line">  // 判断机型为 ios</span><br><span class="line">  if (CONFIG.browser.ios) &#123;</span><br><span class="line">     // 加载二维码图片</span><br><span class="line">     this.fetchImage(options.qrImgUrl, function(myBlob) &#123;</span><br><span class="line">     const objectURL = URL.createObjectURL(myBlob); // 将 Blob 生成 URL</span><br><span class="line">     qrImg.src = objectURL;</span><br><span class="line"></span><br><span class="line">     // 延迟检查图片是否加载完成，可以改为轮询形式，complete 成功后关掉定时器</span><br><span class="line">     setTimeout(function() &#123;</span><br><span class="line">        if (qrImg.complete) &#123;</span><br><span class="line">        // 绘制二维码图片</span><br><span class="line">        context.drawImage(qrImg, qrL, qrR, qrWH, qrWH);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">        const logoImg = new Image();</span><br><span class="line">        // 加载支付通道 logo，原理同上</span><br><span class="line">        this.fetchImage(options.logoImgUrl, function(myBlob) &#123;</span><br><span class="line">        const objectURL = URL.createObjectURL(myBlob);</span><br><span class="line">        logoImg.src = objectURL;</span><br><span class="line">        setTimeout(function() &#123;</span><br><span class="line">           if (logoImg.complete) &#123;</span><br><span class="line">           context.drawImage(logoImg, logoL, logoR, logoWH, logoWH);</span><br><span class="line">           // 完成绘制后，执行回调</span><br><span class="line">           options.callback(canvas);</span><br><span class="line">         &#125;</span><br><span class="line">         &#125;, 60);</span><br><span class="line">      &#125;);</span><br><span class="line">      &#125;, 60);</span><br><span class="line">   &#125;);</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     //图片跨域访问</span><br><span class="line">     qrImg.setAttribute(&apos;crossOrigin&apos;, &apos;Anonymous&apos;);</span><br><span class="line"></span><br><span class="line">     qrImg.onload = function() &#123;</span><br><span class="line">     context.drawImage(qrImg, qrL, qrR, qrWH, qrWH);</span><br><span class="line">     //下载支付通道 logo</span><br><span class="line">     const logoImg = new Image();</span><br><span class="line">     logoImg.setAttribute(&apos;crossOrigin&apos;, &apos;Anonymous&apos;);</span><br><span class="line"></span><br><span class="line">     logoImg.onload = function() &#123;</span><br><span class="line">        context.drawImage(logoImg, logoL, logoR, logoWH, logoWH);</span><br><span class="line">        // 完成绘制后，回调</span><br><span class="line">        options.callback(canvas);</span><br><span class="line">      &#125;;</span><br><span class="line">     logoImg.src = options.logoImgUrl;</span><br><span class="line">   &#125;;</span><br><span class="line">     qrImg.src = options.qrImgUrl;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  context.font = &apos;12px Helvetica Neue,Tahoma,Arial,PingFangSC-Regular,Hiragino Sans GB,Microsoft Yahei,sans-serif&apos;;</span><br><span class="line"></span><br><span class="line">  // 金额样式</span><br><span class="line">  context.fillStyle = &apos;#f00&apos;;</span><br><span class="line">  context.textAlign = &apos;center&apos;;</span><br><span class="line">  context.fillText(`￥$&#123;options.sum&#125;`, 140, 26 + 150 + 10);</span><br><span class="line">  context.fillText(`仅限$&#123;options.userLoginName&#125; $&#123;options.branchName&#125;使用`, 140, 26 + 150 + 25);</span><br><span class="line"></span><br><span class="line">  // 提示语样式</span><br><span class="line">  context.fillStyle = &apos;#000&apos;;</span><br><span class="line">  context.textAlign = &apos;left&apos;;</span><br><span class="line">  const tipList = options.tipList;</span><br><span class="line"></span><br><span class="line">  //如果是微信付款就添加提交数据</span><br><span class="line">  if (options.payproductName === &apos;WECHAT&apos;) &#123;</span><br><span class="line">     tipList[0] = &apos;请打开微信 APP 扫一扫&apos;;</span><br><span class="line">     tipList.splice(2, 0, &apos;请勿在扫码页面从相册选取二维码进行识别&apos;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  const len = tipList.length;</span><br><span class="line">  for (let i = 0; i &lt; len; i++) &#123;</span><br><span class="line">     context.fillText(i + 1 + &apos;.&apos; + tipList[i] + (i === len - 1 ? &apos;。&apos; : &apos;；&apos;), 16, 220 + 16 \* i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">fetchImage(imgUrl, cb) &#123;</span><br><span class="line">  fetch(imgUrl)</span><br><span class="line">  .then(function(res) &#123;</span><br><span class="line">    if (res.ok) &#123;</span><br><span class="line">    return res.blob();</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(function(myBlob) &#123;</span><br><span class="line">    cb(myBlob);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>       由于fetch有些兼容性的问题，所以会考虑到用xhr来实验一下，用xhr来获取图片的Blob：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;img id=&quot;myImg&quot; src=&quot;&quot; /&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  function loadImage(url, callback) &#123;</span><br><span class="line">    if (typeof callback !== &apos;function&apos;) &#123;</span><br><span class="line">      callback = function(url) &#123;</span><br><span class="line">        console.log(url);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    var xhr = new XMLHttpRequest();</span><br><span class="line">    xhr.responseType = &apos;blob&apos;;</span><br><span class="line">    xhr.onload = function(req) &#123;</span><br><span class="line">      console.log(xhr.response)</span><br><span class="line">      const resToUrl = window.URL.createObjectURL(xhr.response);</span><br><span class="line">      console.log(resToUrl)</span><br><span class="line">      callback(resToUrl);</span><br><span class="line">    &#125;;</span><br><span class="line">    xhr.open(&apos;GET&apos;, url, true);</span><br><span class="line">    xhr.send();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //使用方法</span><br><span class="line">  var imgUrl = &apos;http://qimg.hxnews.com/2019/0203/1549199908936.jpg&apos;;</span><br><span class="line">  loadImage(imgUrl, function(url) &#123;</span><br><span class="line">    document.getElementById(&apos;myImg&apos;).setAttribute(&apos;src&apos;, url);</span><br><span class="line">  &#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/日常tips/">日常tips</a></div><div class="post-nav"><a class="pre" href="/2019/03/01/封装调用接口的函数，返回接口的返回值/">封装调用接口的函数，返回接口的返回值</a><a class="next" href="/2019/02/20/小程序-组件/">小程序-组件篇</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/tips/">tips</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端笔记/">前端笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端面试之道/">前端面试之道</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/年度总结/">年度总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/个人总结/" style="font-size: 15px;">个人总结</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/redux/" style="font-size: 15px;">redux</a> <a href="/tags/ts/" style="font-size: 15px;">ts</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/小程序/" style="font-size: 15px;">小程序</a> <a href="/tags/日常tips/" style="font-size: 15px;">日常tips</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/04/23/使用Babel开发Typescript/">使用Babel开发Typescript</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/20/H5的rem适配方案/">H5的rem适配方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/01/封装调用接口的函数，返回接口的返回值/">封装调用接口的函数，返回接口的返回值</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/22/解决IOS上new Image()的onload事件失效/">解决IOS上new Image()的onload事件失效</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/20/小程序-组件/">小程序-组件篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/18/小程序-基础/">小程序-框架基础篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/12/浏览器缓存机制/">浏览器缓存机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/25/浏览器基础知识点及常考面试题/">浏览器基础知识点及常考面试题</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/23/JS进阶知识点及常考面试题/">JS进阶知识点及常考面试题</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/22/Event Loop/">Event Loop</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/MaTonna" title="github" target="_blank">github</a><ul></ul><a href="https://blog.csdn.net/qq_14863671" title="CSDN" target="_blank">CSDN</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">MaTonna's blog</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>